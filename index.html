<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Wren AI Cloud API Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --sidebar-width: 250px;
            --bg-light: #f8f9fa;
            --text-dark: #343a40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            color: var(--text-dark);
            background-color: white;
        }

        /* --- å´é‚Šæ¬„ (Sidebar) æ¨£å¼ --- */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-light);
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
        }

        .sidebar-menu-item, .sidebar-header {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-menu-item:hover:not(.active) {
            background-color: #e9ecef;
        }

        .sidebar-menu-item.active {
            background-color: #e0f7ff;
            border-left: 3px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .sidebar-header {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 15px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        /* --- é…ç½®å€å¡Š (Configuration) æ¨£å¼ --- */
        .config-group {
            padding: 10px 20px;
            margin-top: 10px;
        }
        .config-group label {
            display: block;
            font-size: 0.9em;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .config-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
        }
        /* é©—è­‰æŒ‰éˆ•æ¨£å¼ */
        .config-group button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .config-group button:hover {
            background-color: #0056b3;
        }
        .config-group button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        /* --- ä¸»å…§å®¹å€ (Main Content) æ¨£å¼ --- */
        #content-area {
            flex-grow: 1;
            padding: 20px 40px;
            overflow-y: auto;
        }

        #content-area h1 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* é€šç”¨è¼¸å‡ºæ¨£å¼ */
        .output-box { 
            white-space: pre-wrap; 
            border: 1px solid #ced4da; 
            padding: 15px; 
            min-height: 100px; 
            margin-top: 15px;
            background-color: #f9f9f9;
            font-family: monospace;
            overflow-x: auto;
        }
        
        #chartContainer { 
            border: 1px solid #007bff; 
            padding: 15px; 
            margin-top: 20px;
            background-color: #e6f7ff;
            min-height: 200px;
        }
        .controls { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 20px; 
            padding: 15px; 
            background-color: #f1f1f1;
            border-radius: 5px;
        }
        .controls input[type="text"] {
            flex-grow: 1;
        }
        .controls button {
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .controls button:hover {
            background-color: #0056b3;
        }
        .controls button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .panel {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 14px;
            background: #ffffff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }

        .kv { display: grid; gap: 6px; }
        .kv-key {
            display: inline-block;
            min-width: 64px;
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
        }
        .kv-val { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

        .codebox {
            background: #0b1020;
            color: #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            overflow-x: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
        }

        .timeline { list-style: none; padding-left: 0; margin: 0; }
        .timeline li {
            border-left: 3px solid #e5e7eb;
            padding: 6px 10px;
            margin: 4px 0 4px 6px;
            position: relative;
        }
        .timeline li::before {
            content: "";
            width: 10px; height: 10px;
            border-radius: 50%;
            background: #93c5fd;
            position: absolute; left: -6px; top: 10px;
        }
        .timeline .badge {
            display: inline-block;
            font-size: 12px;
            padding: 1px 6px;
            border-radius: 999px;
            background: #e0f2fe;
            color: #0369a1;
            margin-right: 6px;
        }
        #streamSQL:hover {
        box-shadow: 0 0 5px rgba(0,123,255,0.4);
        cursor: text;
        }
        /* è®“ grid å…§çš„é¢æ¿å…è¨±ç¸®é€²æ¬„å¯¬ï¼Œé¿å…æ’çˆ†é€ æˆæ›è¡Œ/æ¶ˆå¤± */
        .two-col { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 16px; 
        align-items: start;           /* é¿å…è¢«æ‹‰æˆç­‰é«˜ */
        }
        .two-col .panel { 
        min-width: 0;                 /* é—œéµï¼å…è¨±å…§éƒ¨å…ƒç´ ç¸®é€² */
        }

        /* Raw JSON èˆ‡æœ€çµ‚å›ç­”éƒ½å¯ç¨ç«‹æ²å‹•ï¼Œé¿å…æ’ç‰ˆ */
        #streamOutput,
        #finalAnswer {
        max-height: 50vh;
        overflow: auto;               /* åŒæ™‚é–‹å•Ÿ x/y æ²è»¸ */
        word-break: break-word;       /* JSON è£¡çš„é•· token ä¹Ÿèƒ½æ–· */
        }

        /* SQL å€å¡ŠçœŸæ­£å¯æ²å‹•ï¼ˆåŒæ™‚ä¿ç•™åŸæœ¬æ·±è‰²æ¨£å¼ï¼‰ */
        #streamSQL {
        display: block;
        max-height: 220px;
        overflow: auto;               /* x/y éƒ½é–‹ */
        white-space: pre;             /* ä¸è‡ªå‹•æ›è¡Œï¼Œæ”¹é æ²å‹• */
        box-sizing: border-box;
        min-width: 0;                 /* é—œéµï¼é…åˆ grid é¿å…è¢«æˆªæ–· */
        }
        /* è®“ JSON é¡¯ç¤ºå€å¯æ²å‹•ã€ä¸æˆªæ–· */
        #chartOutput,
        #sqlOutput,
        #streamOutput {
        max-height: 50vh;     /* è¦–çª—é«˜åº¦ä¸€åŠï¼Œå¯è‡ªè¡Œèª¿æ•´ */
        overflow: auto;       /* x / y éƒ½å¯æ²å‹• */
        white-space: pre;     /* ä¿ç•™åŸæœ¬æ›è¡Œèˆ‡ç¸®æ’ï¼Œä¸è‡ªå‹•æ›è¡Œ */
        word-break: normal;   /* é¿å…ç¡¬åˆ‡å­— */
        box-sizing: border-box;
        min-width: 0;         /* é…åˆ gridï¼Œé¿å…è¢«å…§å®¹æ’çˆ† */
        }

    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header" style="font-size: 1.2em; color: var(--text-dark); padding: 15px 20px;">Wren AI API Demo</div>

        <div class="sidebar-header">Home</div>
        <div class="sidebar-menu-item active" data-tab="home">Home</div>
        
        <div class="sidebar-header">Features</div>
        <div class="sidebar-menu-item" data-tab="ask-streaming">Ask Streaming</div>
        <div class="sidebar-menu-item" data-tab="sql-generation">SQL Generation</div>
        <div class="sidebar-menu-item" data-tab="chart-generation">Chart Generation</div>
        
        <div class="sidebar-header config-group">Configuration</div>
        <div class="config-group" id="config-group-input">
            <label for="apiKeyInput">API Key</label>
            <input type="password" id="apiKeyInput" placeholder="sk-..." value="sk-nFiCyqyXTI6UQw"> 
        </div>
        <div class="config-group">
            <label for="projectIdInput">project_id</label>
            <input type="text" id="projectIdInput" placeholder="e.g., 11312
            " value="11312">
            
            <button id="validateButton" onclick="handleValidateConfig()" style="width: 100%; margin-top: 10px;">
                é©—è­‰ Key & project_id
            </button>
            <p id="validationStatus" style="font-size: 0.85em; margin-top: 5px; font-weight: bold; color: gray;">
                è«‹è¼¸å…¥ Key å’Œ ID ä¸¦é»æ“Šé©—è­‰
            </p>
        </div>
    </div>

    <div id="content-area">
        
        <div id="home" class="tab-content active">
            <h1>Wren AI Cloud API Demo</h1>
            <h2>æ¸¬è©¦æ­¥é©Ÿ:</h2>
            <ol>
                <li>åœ¨å·¦å´ Configuration æ¬„ä½è¼¸å…¥ **API Key** å’Œ **project_id**ã€‚</li>
                <li>é»æ“Š **é©—è­‰ Key & project_id** æŒ‰éˆ•ã€‚</li>
                <li>é©—è­‰æˆåŠŸå¾Œï¼Œé»æ“Šå·¦å´ä»»ä¸€åŠŸèƒ½æ¨™ç±¤ (ä¾‹å¦‚ Ask Streaming)ã€‚</li>
                <li>è¼¸å…¥æ‚¨çš„è³‡æ–™åº«ç›¸é—œæŸ¥è©¢ä¸¦é‹è¡Œã€‚</li>
            </ol>
            <h2>Resources:</h2>
            <ul>
                <li>Wren AI official website: <a href="https://getwren.ai/" target="_blank">https://getwren.ai/</a></li>
            </ul>
        </div>
        
        <div id="ask-streaming" class="tab-content">
            <h1>Ask Streaming Demo</h1>
            <p>ä½¿ç”¨ <strong>/stream/ask</strong> ç«¯é»ï¼Œå¯¦æ™‚ç²å– AI çš„æ¨ç†å’Œçµæœã€‚</p>

            <div class="controls" id="ask-streaming-controls">
                <input type="text" id="streamQueryInput" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ (ä¾‹å¦‚: total sales for last quarter)" value="total sales from 2018-07-01 to 2018-09-30">
                <button onclick="runFeatureDemo('stream/ask')">Run Stream /ask</button>
            </div>

            <!-- æ–°å¢ï¼šé›™æ¬„å¸ƒå±€ï¼ˆå·¦ï¼šäººé¡å¯è®€æ‘˜è¦ï¼›å³ï¼šåŸå§‹äº‹ä»¶ï¼‰ -->
            <div class="two-col">
                <div class="panel">
                    <h3>äººé¡å¯è®€æ‘˜è¦</h3>

                    <div class="kv">
                        <div><span class="kv-key">ç‹€æ…‹</span><span class="kv-val" id="streamStatus">â€”</span></div>
                        <div><span class="kv-key">å•é¡Œ</span><span class="kv-val" id="streamQuestion">â€”</span></div>
                        <div><span class="kv-key">Thread</span><span class="kv-val" id="streamThread">â€”</span></div>
                    </div>

                    <h4 style="margin-top:14px;">ç”Ÿæˆ SQL</h4>
                    <pre id="streamSQL" class="codebox">// å°šæœªç”Ÿæˆ</pre>

                    <h4 style="margin-top:14px;">æœ€çµ‚å›ç­”</h4>
                    <div id="finalAnswer" class="output-box" style="min-height:80px;"></div>

                    <h4 style="margin-top:14px;">æ™‚é–“ç·š</h4>
                    <ul id="timeline" class="timeline"></ul>
                </div>

                <div class="panel">
                    <h3>åŸå§‹äº‹ä»¶ (Raw)</h3>
                    <div id="streamOutput" class="output-box"></div>
                </div>
            </div>
        </div>

        
        <div id="sql-generation" class="tab-content">
            <h1>SQL Generation Demo</h1>
            <p>ä½¿ç”¨ <strong>/generate_sql</strong> ç«¯é»ï¼Œåƒ…å°‡è‡ªç„¶èªè¨€è½‰æ›ç‚º SQL èªå¥ã€‚</p>

            <div class="controls" id="sql-generation-controls">
                <input type="text" id="sqlQueryInput" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ (ä¾‹å¦‚: customers with revenue > 1000)" value="customers with revenue > 1000">
                <button onclick="runFeatureDemo('generate_sql')">Run /generate_sql</button>
            </div>

            <!-- é›™æ¬„ï¼šå·¦ äººé¡å¯è®€æ‘˜è¦ï¼›å³ Raw JSON -->
            <div class="two-col">
                <div class="panel">
                    <h3>äººé¡å¯è®€æ‘˜è¦</h3>

                    <h4>ç”Ÿæˆ SQL <button id="copySQLBtn" style="margin-left:8px; padding:2px 8px;" onclick="copyGeneratedSQL()">ğŸ“‹ è¤‡è£½</button></h4>
                    <pre id="genSQL" class="codebox">// å°šæœªç”Ÿæˆ</pre>

                    <h4 style="margin-top:14px;">èªªæ˜ / æ¨ç†</h4>
                    <div id="genSummary" class="output-box" style="min-height:80px;"></div>

                    <h4 style="margin-top:14px;">æ¶‰åŠè³‡æ–™è¡¨</h4>
                    <ul id="genTables" class="timeline"></ul>
                    </div>

                    <div class="panel">
                    <h3>åŸå§‹ JSON (Raw)</h3>
                    <div id="sqlOutput" class="output-box"></div>
                </div>
            </div>
        </div>
        
        <div id="chart-generation" class="tab-content">
            <h1>Chart Generation Demo</h1>
            <p>ä¸²è¯ /generate_sql èˆ‡ /generate_vega_chartï¼Œä¸€éµç”Ÿæˆåœ–è¡¨ã€‚</p>
            <div class="controls" id="chart-generation-controls">
                <input type="text" id="chartQueryInput" placeholder="è¼¸å…¥æ‚¨çš„åœ–è¡¨è«‹æ±‚ (ä¾‹å¦‚: total revenue by month as a line chart)" value="total revenue by month as a line chart">
                <button onclick="runFeatureDemo('generate_chart')">Generate Chart</button>
            </div>
            
            <h3>åœ–è¡¨é¡¯ç¤º:</h3>
            <div id="chartContainer">åœ–è¡¨å°‡é¡¯ç¤ºåœ¨é€™è£¡...</div>
            
            <h3>æœ€çµ‚ JSON éŸ¿æ‡‰:</h3>
            <div id="chartOutput" class="output-box"></div>
        </div>
        
    </div>

    <script>
        // --- é…ç½®èˆ‡åŸºç¤ URLs ---
        const VALIDATE_URL = 'http://127.0.0.1:8000/api/validate-key';
        const NON_STREAM_BASE_URL = 'http://127.0.0.1:8000/api/wren-call'; 
        const STREAM_BASE_URL = 'http://127.0.0.1:8000/api/stream-call';

        // --- UI è¼”åŠ©å‡½æ•¸ ---
        
        function checkConfig() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const projectId = document.getElementById('projectIdInput').value.trim();

            if (!apiKey || !projectId) {
                document.getElementById('validationStatus').textContent = "âŒ è«‹è¼¸å…¥ API Key å’Œ project_idã€‚";
                document.getElementById('validationStatus').style.color = 'red';
                return null;
            }
            return { apiKey, projectId };
        }

        function getOutputElement(action) {
            if (action === 'generate_sql') return document.getElementById('sqlOutput');
            if (action === 'generate_chart') return document.getElementById('chartOutput');
            if (action === 'stream/ask') return document.getElementById('streamOutput');
            return null;
        }

        function toggleButton(containerId, disabled) {
            document.querySelector(`#${containerId}-controls button`).disabled = disabled;
        }

        function clearContainers() {
            document.getElementById('chartContainer').innerHTML = 'åœ–è¡¨å°‡é¡¯ç¤ºåœ¨é€™è£¡...';
            document.getElementById('streamOutput').textContent = '';
            document.getElementById('sqlOutput').textContent = '';
            document.getElementById('chartOutput').textContent = '';

            // æ–°å¢ï¼šæ¸…ç©ºäººé¡å¯è®€å€å¡Š
            const statusEl = document.getElementById('streamStatus');
            const qEl = document.getElementById('streamQuestion');
            const threadEl = document.getElementById('streamThread');
            const sqlEl = document.getElementById('streamSQL');
            const ansEl = document.getElementById('finalAnswer');
            const tlEl = document.getElementById('timeline');

            if (statusEl) statusEl.textContent = 'â€”';
            if (qEl) qEl.textContent = 'â€”';
            if (threadEl) threadEl.textContent = 'â€”';
            if (sqlEl) sqlEl.textContent = '// å°šæœªç”Ÿæˆ';
            if (ansEl) ansEl.textContent = '';
            if (tlEl) tlEl.innerHTML = '';
        }

        
        document.querySelectorAll('.sidebar-menu-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.sidebar-menu-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(this.dataset.tab).classList.add('active');
                
                clearContainers(); 
            });
        });

        // --- é©—è­‰é‚è¼¯ï¼šå‘¼å« /api/validate-key ---
        async function handleValidateConfig() {
            const config = checkConfig();
            if (!config) return;

            const validateButton = document.getElementById('validateButton');
            const statusElement = document.getElementById('validationStatus');
            
            validateButton.disabled = true;
            statusElement.textContent = "âš™ï¸ æ­£åœ¨é©—è­‰ Key å’Œ project_id...";
            statusElement.style.color = 'orange';
            
            try {
                // Query åƒæ•¸ä½¿ç”¨ project_id
                const url = `${VALIDATE_URL}?project_id=${config.projectId}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Wren-API-Key': config.apiKey,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `é©—è­‰å¤±æ•— (Status: ${response.status})`);
                }

                statusElement.textContent = "âœ… é©—è­‰æˆåŠŸï¼Key å¯å­˜å–æ­¤ project_idã€‚";
                statusElement.style.color = 'green';
                
            } catch (error) {
                statusElement.textContent = `âŒ é©—è­‰å¤±æ•—: ${error.message}`;
                statusElement.style.color = 'red';
            } finally {
                validateButton.disabled = false;
            }
        }

        // --- æ ¸å¿ƒ API å‘¼å«å‡½æ•¸ï¼ˆéä¸²æµï¼‰---
        async function makeWrenCall(endpoint, query, config, sql = null) {
            const payload = { 
                // JSON Key ä½¿ç”¨ project_id
                project_id: config.projectId, 
                text: query,
                additional_payload: { 
                    ...(sql ? { sql: sql } : {})
                }
            };
            const url = `${NON_STREAM_BASE_URL}/${endpoint}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Wren-API-Key': config.apiKey 
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`HTTP éŒ¯èª¤ ${response.status} å‘¼å« /${endpoint}: ${errorData.detail || response.statusText}`);
            }

            return response.json();
        }

        // --- ä¸²æµ SSE è™•ç†å‡½æ•¸ ---
        async function handleStreamingCall(endpoint, query, config) {
            const url = `${STREAM_BASE_URL}/${endpoint}`;
            const streamOutputElement = document.getElementById('streamOutput');

            // æ–°å¢ï¼šäººé¡å¯è®€è¦–åœ–çš„ç¯€é»
            const statusEl = document.getElementById('streamStatus');
            const qEl = document.getElementById('streamQuestion');
            const threadEl = document.getElementById('streamThread');
            const sqlEl = document.getElementById('streamSQL');
            const ansEl = document.getElementById('finalAnswer');
            const tlEl = document.getElementById('timeline');

            // å…§éƒ¨ç‹€æ…‹
            let answerBuffer = '';
            let seenStates = new Set();

            // å°å·¥å…·ï¼šæ™‚é–“ç·š append
            const addTimeline = (label, detail) => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="badge">${label}</span>${detail || ''}`;
                tlEl.appendChild(li);
                tlEl.scrollTop = tlEl.scrollHeight;
            };

            // ä¾ä¸åŒäº‹ä»¶æ›´æ–°å¯è®€è¦–åœ–
            const updateReadableView = (payload) => {
                if (!payload) return;

                // 1) å•Ÿå‹•/çµæŸ
                if (payload.type === 'message_start') {
                statusEl.textContent = 'é€£ç·šå·²å»ºç«‹ï¼Œæº–å‚™ä¸­â€¦';
                qEl.textContent = query;
                addTimeline('start', 'é–‹å§‹è™•ç†è«‹æ±‚');
                return;
                }
                if (payload.type === 'message_stop') {
                statusEl.textContent = 'å®Œæˆ';
                addTimeline('done', 'ä¸²æµçµæŸ');
                return;
                }

                // 2) ä¸­ç¹¼ state
                if (payload.type === 'state' && payload.data) {
                const s = payload.data.state;
                if (s && !seenStates.has(s)) {
                    seenStates.add(s);
                    addTimeline('state', s);
                    statusEl.textContent = s;
                }

                if (payload.data.question) {
                    qEl.textContent = payload.data.question;
                }
                if (payload.data.threadId) {
                    threadEl.textContent = payload.data.threadId;
                }
                if (payload.data.sql) {
                    sqlEl.textContent = payload.data.sql;
                }
                return;
                }

                // 3) æ–‡å­—å¡Šï¼ˆæœ€çµ‚ç­”æ¡ˆï¼‰
                if (payload.type === 'content_block_delta' && payload.delta && payload.delta.text) {
                answerBuffer += payload.delta.text;
                ansEl.textContent = answerBuffer;
                ansEl.scrollTop = ansEl.scrollHeight;
                return;
                }

                // 4) å…¶ä»–å…§å®¹å¡Šäº‹ä»¶ï¼ˆé–‹å§‹/çµæŸï¼‰
                if (payload.type === 'content_block_start') {
                addTimeline('content', `é–‹å§‹ï¼š${payload.content_block?.name || payload.content_block?.type || 'text'}`);
                return;
                }
                if (payload.type === 'content_block_stop') {
                addTimeline('content', `çµæŸï¼š${payload.content_block?.name || payload.content_block?.type || 'text'}`);
                return;
                }
            };

            streamOutputElement.textContent = `é€£æ¥åˆ° ${url}ï¼Œç­‰å¾…ä¸²æµäº‹ä»¶...`;

            try {
                const payload = { project_id: config.projectId, text: query };
                const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Wren-API-Key': config.apiKey
                },
                body: JSON.stringify(payload)
                });

                if (!response.ok) {
                const err = await response.json();
                throw new Error(`Proxy Error ${response.status}: ${err.detail || 'Unknown Error'}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = "";

                const processText = async ({ done, value }) => {
                if (done) {
                    streamOutputElement.textContent += "\n\n--- ä¸²æµçµæŸ ---";
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                let events = buffer.split('\n\n');
                buffer = events.pop();

                events.forEach(event => {
                    if (event.trim() === "") return;

                    const dataMatch = event.match(/data: (.*)/);
                    const eventMatch = event.match(/event: (.*)/);

                    let data = dataMatch ? dataMatch[1].trim() : '';
                    let type = eventMatch ? eventMatch[1].trim() : 'message';

                    // åŸå§‹è¼¸å‡ºï¼ˆä¿ç•™ï¼‰
                    let displayData = data;
                    try {
                    const payload = JSON.parse(data);
                    displayData = `[${type.toUpperCase()}]\n` + JSON.stringify(payload, null, 2);
                    updateReadableView(payload); // â† æ–°å¢ï¼šåŒæ­¥æ›´æ–°å¯è®€æ‘˜è¦
                    } catch (e) {
                    displayData = `[${type.toUpperCase()}]\n` + data;
                    }
                    streamOutputElement.textContent += `${displayData}\n\n`;
                    streamOutputElement.scrollTop = streamOutputElement.scrollHeight;
                });

                return reader.read().then(processText);
                };

                return reader.read().then(processText);

            } catch (error) {
                console.error('ä¸²æµæ“ä½œå¤±æ•—:', error);
                streamOutputElement.textContent = `ä¸²æµå¤±æ•—: ${error.message}`;
                // å¯è®€è¦–åœ–ä¹Ÿé¡¯ç¤ºéŒ¯èª¤
                if (statusEl) statusEl.textContent = `éŒ¯èª¤ï¼š${error.message}`;
            }
        }



        // --- ä¸»è¦æ§åˆ¶å‡½æ•¸ ---
        async function runFeatureDemo(action) {
            clearContainers();
            
            const config = checkConfig();
            if (!config) {
                alert("è«‹å…ˆè¼¸å…¥ API Key å’Œ project_idï¼Œä¸¦é»æ“Šé©—è­‰ã€‚");
                return;
            }
            
            let queryInputId;
            let containerId;
            
            if (action === 'stream/ask') {
                queryInputId = 'streamQueryInput';
                containerId = 'ask-streaming';const query = document.getElementById(queryInputId).value.trim();
                const outputElement = document.getElementById('streamOutput');

                if (!query) { outputElement.textContent = "è«‹è¼¸å…¥ä¸€å€‹æŸ¥è©¢ã€‚"; return; }
                toggleButton(containerId, true);
                try {
                    await handleStreamingCall('stream/ask', query, config);
                } finally {
                    // æ³¨æ„ï¼šä¸²æµæ˜¯é•·é€£ç·šï¼›é€šå¸¸ä¸åœ¨é€™è£¡è‡ªå‹• re-enableï¼Œ
                    // ä½†ç‚ºäº†è·Ÿå…¶ä»–é ä¸€è‡´ï¼Œä¿ç•™é€™è¡Œ
                    toggleButton(containerId, false);
                }
                return;  // é€™è¡Œå¾ˆé‡è¦ï¼Œé¿å…å¾€ä¸‹è·‘åˆ°å…¶ä»–åˆ†æ”¯

            } else if (action === 'generate_sql') {
                queryInputId = 'sqlQueryInput';
                containerId = 'sql-generation';

                const query = document.getElementById(queryInputId).value.trim();
                const outputElement = document.getElementById('sqlOutput'); // Raw JSON å³æ¬„
                const sqlBox = document.getElementById('genSQL');           // å·¦æ¬„ SQL
                const summaryBox = document.getElementById('genSummary');   // å·¦æ¬„ èªªæ˜
                const tablesList = document.getElementById('genTables');    // å·¦æ¬„ è¡¨æ¸…å–®

                if (!query) { outputElement.textContent = "è«‹è¼¸å…¥ä¸€å€‹æŸ¥è©¢ã€‚"; return; }
                toggleButton(containerId, true);

                // å…ˆæ¸…ç©ºå·¦æ¬„
                if (sqlBox) sqlBox.textContent = '// å°šæœªç”Ÿæˆ';
                if (summaryBox) summaryBox.textContent = '';
                if (tablesList) tablesList.innerHTML = '';

                try {
                    outputElement.textContent = "æ­£åœ¨å‘¼å« Wren AI /generate_sql...";
                    const responseData = await makeWrenCall('generate_sql', query, checkConfig());

                    // Raw JSON
                    outputElement.textContent = JSON.stringify(responseData, null, 2);

                    // å…¼å®¹ä¸åŒæ¬„ä½åç¨±
                    const sql = responseData.sql 
                            || responseData.data?.sql 
                            || responseData.generated_sql 
                            || null;

                    const reasoning = responseData.reasoning
                                || responseData.sqlGenerationReasoning
                                || responseData.explanation
                                || responseData.summary
                                || '';

                    const tables = responseData.retrievedTables
                                || responseData.data?.retrievedTables
                                || responseData.tables
                                || [];

                    // å·¦æ¬„ï¼šSQL
                    if (sqlBox) {
                    sqlBox.textContent = sql || '// æœªå–å¾— SQL';
                    // ç¢ºä¿è·³åˆ°åº•ã€é¡¯ç¤ºæ²è»¸
                    sqlBox.scrollTop = 0;
                    }

                    // å·¦æ¬„ï¼šèªªæ˜
                    if (summaryBox) {
                    summaryBox.textContent = reasoning ? String(reasoning) : 'ï¼ˆç„¡èªªæ˜ï¼‰';
                    }

                    // å·¦æ¬„ï¼šè³‡æ–™è¡¨æ¸…å–®
                    if (tablesList) {
                    if (Array.isArray(tables) && tables.length > 0) {
                        tablesList.innerHTML = '';
                        tables.forEach(t => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span class="badge">table</span>${t}`;
                        tablesList.appendChild(li);
                        });
                    } else {
                        tablesList.innerHTML = '<li><span class="badge">table</span>ï¼ˆæœªæä¾›ï¼‰</li>';
                    }
                    }

                } catch (error) {
                    console.error('æ“ä½œå¤±æ•—:', error);
                    outputElement.textContent = `æ“ä½œå¤±æ•—: ${error.message}`;
                    if (summaryBox) summaryBox.textContent = `âš ï¸ éŒ¯èª¤ï¼š${error.message}`;
                } finally {
                    toggleButton(containerId, false);
                }

                return; // å·²è™•ç† generate_sqlï¼Œæå‰è¿”å›
            } else if (action === 'generate_chart') {
                queryInputId = 'chartQueryInput';
                containerId = 'chart-generation';

                const config = checkConfig();
                if (!config) { alert("è«‹å…ˆè¼¸å…¥ API Key å’Œ project_idï¼Œä¸¦é»æ“Šé©—è­‰ã€‚"); return; }

                const query = document.getElementById(queryInputId).value.trim();
                const outputElement = document.getElementById('chartOutput');
                const chartContainer = document.getElementById('chartContainer');

                if (!query) { outputElement.textContent = "è«‹è¼¸å…¥ä¸€å€‹æŸ¥è©¢ã€‚"; return; }
                toggleButton(containerId, true);

                try {
                    // 1/2: å…ˆè¦ SQL
                    outputElement.textContent = "æ­¥é©Ÿ 1/2: æ­£åœ¨å‘¼å« /generate_sql...";
                    const sqlResponse = await makeWrenCall('generate_sql', query, config);
                    const generatedSql = sqlResponse.sql || sqlResponse.data?.sql || sqlResponse.generated_sql;
                    if (!generatedSql) throw new Error("Wren AI æœªèƒ½ç”Ÿæˆ SQL æŸ¥è©¢ã€‚");
                    outputElement.textContent = `æ­¥é©Ÿ 1/2 å®Œæˆ: æˆåŠŸç”Ÿæˆ SQL:\n${generatedSql}`;

                    // 2/2: å†è¦ Vega-Lite
                    outputElement.textContent += "\n\næ­¥é©Ÿ 2/2: æ­£åœ¨å‘¼å« /generate_vega_chart...";
                    const chartResponse = await makeWrenCall('generate_vega_chart', query, config, generatedSql);

                    // â† é—œéµï¼šå½ˆæ€§è§£æ Vega-Lite è¦ç¯„
                    const vegaSpec = extractVegaLiteSpec(chartResponse);
                    if (!vegaSpec) {
                    // æŠŠå®Œæ•´å›æ‡‰å°å‡ºä¾†å¹«åŠ©é™¤éŒ¯
                    outputElement.textContent = `æ“ä½œå¤±æ•—: Wren AI æœªèƒ½ç”Ÿæˆ Vega-Lite è¦ç¯„ã€‚\n\nå®Œæ•´å›æ‡‰ï¼š\n${JSON.stringify(chartResponse, null, 2)}`;
                    chartContainer.innerHTML = 'åœ–è¡¨å°‡é¡¯ç¤ºåœ¨é€™è£¡...';
                    return;
                    }

                    // è‹¥ spec æ˜¯åˆæ³•ç‰©ä»¶ï¼ŒåµŒå…¥é¡¯ç¤º
                    await vegaEmbed('#chartContainer', vegaSpec);
                    outputElement.textContent = JSON.stringify(chartResponse, null, 2);

                } catch (error) {
                    console.error('æ“ä½œå¤±æ•—:', error);
                    outputElement.textContent = `æ“ä½œå¤±æ•—: ${error.message}`;
                    chartContainer.innerHTML = 'åœ–è¡¨å°‡é¡¯ç¤ºåœ¨é€™è£¡...';
                } finally {
                    toggleButton(containerId, false);
                }

                return;
                }else {
                return;
            }
        }
        function copyGeneratedSQL() {
            const sqlBox = document.getElementById('genSQL');
            const text = sqlBox ? sqlBox.textContent : '';
            if (!text || text.trim() === '' || text.includes('å°šæœªç”Ÿæˆ')) {
                alert('ç›®å‰æ²’æœ‰å¯è¤‡è£½çš„ SQLã€‚');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copySQLBtn');
                const old = btn.textContent;
                btn.textContent = 'âœ… å·²è¤‡è£½';
                setTimeout(() => btn.textContent = old, 1200);
            }).catch(() => alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚'));
            }
            function extractVegaLiteSpec(resp) {
            // ç›¡é‡æŠŠå¸¸è¦‹å‘½å/çµæ§‹éƒ½æ’ˆä¸€é
                const candidates = [
                    resp?.vega_lite_spec,
                    resp?.vegaLiteSpec,
                    resp?.vega_lite,
                    resp?.vegaLite,
                    resp?.vegaSpec,                       // â† æ–°å¢ï¼šä½ ç¾åœ¨çš„å›å‚³éµ
                    resp?.chart?.vega_lite_spec,
                    resp?.chart?.vegaLiteSpec,
                    resp?.chart?.vegaSpec,                // â† ä¹Ÿé †æ‰‹è£œ
                    resp?.data?.vega_lite_spec,
                    resp?.data?.vegaLiteSpec,
                    resp?.data?.vegaSpec,                 // â† ä¹Ÿé †æ‰‹è£œ
                    resp?.spec,              // æœ‰äº›æœå‹™ç›´æ¥å« spec
                ];

                for (let c of candidates) {
                    if (!c) continue;
                    // å¯èƒ½å·²æ˜¯ç‰©ä»¶ï¼Œä¹Ÿå¯èƒ½æ˜¯å­—ä¸²
                    if (typeof c === 'string') {
                    try { return JSON.parse(c); } catch { /* ä¸æ˜¯ JSON å­—ä¸²å°±ç•¥é */ }
                    } else if (typeof c === 'object') {
                    return c;
                    }
                }
                return null;
        }

    </script>
</body>
</html>